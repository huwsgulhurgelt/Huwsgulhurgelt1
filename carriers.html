<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–æ–ª–æ–º–∂–∏—Ç —Ö“Ø—Ä–≥—ç–≥—á–∏–¥ - –ú”©—Ä”©–Ω –•“Ø—Ä–≥—ç–ª—Ç</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Paralax-->
    <div class="parallax-bg">
        <div class="parallax-layer layer-1" data-speed="0.2">
            <div class="ball"></div>
            <div class="ball"></div>
            <div class="ball"></div>
            <div class="ball"></div>
        </div>
        <div class="parallax-layer layer-2" data-speed="0.5">
            <div class="ball"></div>
            <div class="ball"></div>
            <div class="ball"></div>
        </div>
        <div class="parallax-layer layer-3" data-speed="1">
            <div class="ball"></div>
            <div class="ball"></div>
            <div class="ball"></div>
        </div>
    </div>

    <div class="container">
        <header class="page-header">
            <a href="index.html" class="back-link">‚Üê –ë—É—Ü–∞—Ö</a>
            <h1>–ë–æ–ª–æ–º–∂–∏—Ç —Ö“Ø—Ä–≥—ç–≥—á–∏–¥</h1>
        </header>

        <!-- haih heseg -->
        <div class="search-section">
            <div class="search-container">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="üîç –£—Ç–∞—Å, —Ç–∞–π–ª–±–∞—Ä, —ç—Å–≤—ç–ª ”©–¥—Ä”©”©—Ä —Ö–∞–π—Ö..."
                    autocomplete="off"
                >
                <div id="searchSuggestions" class="search-suggestions"></div>
            </div>
            <div id="searchStats" class="search-stats"></div>
        </div>

        <main id="carriersContainer" class="carriers-grid">
            <div class="loading">–£–Ω—à–∏–∂ –±–∞–π–Ω–∞...</div>
        </main>

        <footer>
            <p>–°—É—Ä–≥—É—É–ª–∏–π–Ω —Ç”©—Å”©–ª ‚Ä¢ Prototype</p>
        </footer>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ú—ç–¥—ç—ç–ª—ç–ª –∑–∞—Å–∞—Ö</h2>
                <span class="close-modal" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label for="editPhone">–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä</label>
                    <input type="tel" id="editPhone" required>
                </div>

                <div class="form-group">
                    <label for="editDescription">–Æ—É —Ö“Ø—Ä–≥—ç–∂ —á–∞–¥–∞—Ö –≤—ç?</label>
                    <textarea id="editDescription" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label>–•“Ø—Ä–≥—ç–ª—Ç —Ö–∏–π—Ö –±–æ–ª–æ–º–∂—Ç–æ–π ”©–¥—Ä“Ø“Ø–¥</label>
                    <div class="days-selector">
                        <label class="day-checkbox">
                            <input type="checkbox" name="editDays" value="–î–∞–≤–∞–∞">
                            <span>–î–∞–≤–∞–∞</span>
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" name="editDays" value="–ú—è–≥–º–∞—Ä">
                            <span>–ú—è–≥–º–∞—Ä</span>
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" name="editDays" value="–õ—Ö–∞–≥–≤–∞">
                            <span>–õ—Ö–∞–≥–≤–∞</span>
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" name="editDays" value="–ü“Ø—Ä—ç–≤">
                            <span>–ü“Ø—Ä—ç–≤</span>
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" name="editDays" value="–ë–∞–∞—Å–∞–Ω">
                            <span>–ë–∞–∞—Å–∞–Ω</span>
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" name="editDays" value="–ë—è–º–±–∞">
                            <span>–ë—è–º–±–∞</span>
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" name="editDays" value="–ù—è–º">
                            <span>–ù—è–º</span>
                        </label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">–ë–æ–ª–∏—Ö</button>
                    <button type="submit" class="btn-submit">–•–∞–¥–≥–∞–ª–∞—Ö</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Parallaxx scrolll
        window.addEventListener('scroll', () => {
            const layers = document.querySelectorAll('.parallax-layer');
            const scrolled = window.pageYOffset;

            layers.forEach(layer => {
                const speed = layer.dataset.speed;
                const yPos = -(scrolled * speed);
                layer.style.transform = `translateY(${yPos}px)`;
            });
        });
    </script>

    <script type="module">
        // impost firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyArvfvF1FWfqNAJnzfNiyEq0Lm2qioPIas",
            authDomain: "huwsgul-hurgelt.firebaseapp.com",
            databaseURL: "https://huwsgul-hurgelt-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "huwsgul-hurgelt",
            storageBucket: "huwsgul-hurgelt.firebasestorage.app",
            messagingSenderId: "457877716370",
            appId: "1:457877716370:web:5bc6e08801e36010c3d54b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const carriersContainer = document.getElementById('carriersContainer');
        const searchInput = document.getElementById('searchInput');
        const searchSuggestions = document.getElementById('searchSuggestions');
        const searchStats = document.getElementById('searchStats');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');

        let allCarriers = {};
        let filteredCarriers = {};
        let currentEditId = null;
        let currentEditPin = null;

        // Load carriers from Firebase to my website
        onValue(ref(database, 'carriers'), (snapshot) => {
            if (!snapshot.exists()) {
                carriersContainer.innerHTML = '<div class="no-data">–û–¥–æ–æ–≥–æ–æ—Ä —Ö“Ø—Ä–≥—ç–≥—á –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.</div>';
                allCarriers = {};
                filteredCarriers = {};
                updateSearchStats();
                return;
            }

            allCarriers = snapshot.val();
            filteredCarriers = { ...allCarriers };
            displayCarriers(filteredCarriers);
            updateSearchStats();
        });

        // haih ajluulalt
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredCarriers = { ...allCarriers };
                searchSuggestions.style.display = 'none';
                displayCarriers(filteredCarriers);
                updateSearchStats();
                return;
            }

            // shuultuur carriers
            filteredCarriers = {};
            Object.keys(allCarriers).forEach(key => {
                const carrier = allCarriers[key];
                const phone = carrier.phone.toLowerCase();
                const description = carrier.description.toLowerCase();
                const days = carrier.days ? carrier.days.join(' ').toLowerCase() : '';

                if (phone.includes(searchTerm) || 
                    description.includes(searchTerm) || 
                    days.includes(searchTerm)) {
                    filteredCarriers[key] = carrier;
                }
            });

            displayCarriers(filteredCarriers);
            showSuggestions(searchTerm);
            updateSearchStats();
        });

        // recommendations 
        function showSuggestions(searchTerm) {
            const suggestions = new Set();
            
            Object.values(allCarriers).forEach(carrier => {
                // utasnii dugaar sanal bolgoh
                if (carrier.phone.includes(searchTerm)) {
                    suggestions.add(carrier.phone);
                }
                
                // Description ug sanal bolgoh
                const words = carrier.description.toLowerCase().split(' ');
                words.forEach(word => {
                    if (word.includes(searchTerm) && word.length > 2) {
                        suggestions.add(word);
                    }
                });

                // udur sanal bolgoh
                if (carrier.days) {
                    carrier.days.forEach(day => {
                        if (day.toLowerCase().includes(searchTerm)) {
                            suggestions.add(day);
                        }
                    });
                }
            });

            // Display salal bolgolt (hammgiin ihdee 5)
            const suggestionsArray = Array.from(suggestions).slice(0, 5);
            
            if (suggestionsArray.length > 0) {
                searchSuggestions.innerHTML = suggestionsArray
                    .map(suggestion => `
                        <div class="suggestion-item" onclick="fillSearch('${suggestion}')">
                            üîç ${highlightMatch(suggestion, searchTerm)}
                        </div>
                    `)
                    .join('');
                searchSuggestions.style.display = 'block';
            } else {
                searchSuggestions.style.display = 'none';
            }
        }

        // text highlight matching
        function highlightMatch(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }

        // haltiig sanal bolgotoor duurgh
        window.fillSearch = function(suggestion) {
            searchInput.value = suggestion;
            searchSuggestions.style.display = 'none';
            
            // ehluuleh hailt
            const event = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(event);
        };

        // uur gazar darhad sanal bolgoltoos gargah
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                searchSuggestions.style.display = 'none';
            }
        });

        // hailtiin ur dugn shinjleh
        function updateSearchStats() {
            const total = Object.keys(allCarriers).length;
            const showing = Object.keys(filteredCarriers).length;
            
            if (searchInput.value.trim() !== '') {
                searchStats.innerHTML = `${showing} —Ö“Ø—Ä–≥—ç–≥—á –æ–ª–¥–ª–æ–æ (–ù–∏–π—Ç: ${total})`;
                searchStats.style.display = 'block';
            } else {
                searchStats.innerHTML = `–ù–∏–π—Ç ${total} —Ö“Ø—Ä–≥—ç–≥—á`;
                searchStats.style.display = 'block';
            }
        }

        // zuugchdiig haruulah
        function displayCarriers(carriers) {
            carriersContainer.innerHTML = '';

            if (Object.keys(carriers).length === 0) {
                if (searchInput.value.trim() !== '') {
                    carriersContainer.innerHTML = '<div class="no-data"> –•–∞–π–ª—Ç–∞–¥ —Ç–æ—Ö–∏—Ä–æ—Ö —Ö“Ø—Ä–≥—ç–≥—á –æ–ª–¥—Å–æ–Ω–≥“Ø–π</div>';
                } else {
                    carriersContainer.innerHTML = '<div class="no-data">–û–¥–æ–æ–≥–æ–æ—Ä —Ö“Ø—Ä–≥—ç–≥—á –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.</div>';
                }
                return;
            }

            Object.keys(carriers).forEach(key => {
                const carrier = carriers[key];
                const card = createCarrierCard(key, carrier);
                carriersContainer.appendChild(card);
            });
        }

        function createCarrierCard(id, carrier) {
            const card = document.createElement('div');
            card.className = 'carrier-card';

            const daysText = carrier.days ? carrier.days.join(', ') : '”®–¥”©—Ä —Å–æ–Ω–≥–æ–æ–≥“Ø–π';

            // haltad tohirsniig todruulah
            const searchTerm = searchInput.value.toLowerCase();
            let phoneDisplay = carrier.phone;
            let descriptionDisplay = carrier.description;

            if (searchTerm) {
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                phoneDisplay = carrier.phone.replace(regex, '<mark>$1</mark>');
                descriptionDisplay = carrier.description.replace(regex, '<mark>$1</mark>');
            }

            card.innerHTML = `
                <div class="card-content">
                    <div class="carrier-phone">${phoneDisplay}</div>
                    <div class="carrier-description">${descriptionDisplay}</div>
                    <div class="carrier-days">üìÖ ${daysText}</div>
                </div>
                <div class="card-actions">
                    <button class="btn-small btn-edit" onclick="editCarrier('${id}')">–ó–∞—Å–∞—Ö</button>
                    <button class="btn-small btn-delete" onclick="deleteCarrier('${id}')">–£—Å—Ç–≥–∞—Ö</button>
                </div>
            `;

            return card;
        }

        // EDIT hiih
        window.editCarrier = function(id) {
            const pin = prompt('PIN –∫–æ–¥ –æ—Ä—É—É–ª–Ω–∞ —É—É:');
            if (!pin) return;

            const MASTER_PIN = "4133";

            // master pin shalgah
            if (pin === MASTER_PIN) {
                openEditModal(id, pin);
                return;
            }

            // pin oruuldan datag avah
            onValue(ref(database, `carriers/${id}`), (snapshot) => {
                if (snapshot.exists()) {
                    const carrier = snapshot.val();
                    
                    if (carrier.pin !== pin) {
                        alert('–ë—É—Ä—É—É PIN –∫–æ–¥!');
                        return;
                    }

                    // pin zuw baiwal editlj bolno
                    openEditModal(id, pin);
                }
            }, { onlyOnce: true });
        };

        // modal neehed
        function openEditModal(id, pin) {
            currentEditId = id;
            currentEditPin = pin;

            const carrier = allCarriers[id];
            
            // formig data aar dutgeh
            document.getElementById('editPhone').value = carrier.phone;
            document.getElementById('editDescription').value = carrier.description;
            
            // udruudiin checkbox uur dutgeh
            const dayCheckboxes = document.querySelectorAll('input[name="editDays"]');
            dayCheckboxes.forEach(checkbox => {
                checkbox.checked = carrier.days && carrier.days.includes(checkbox.value);
            });

            editModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // modal haah
        window.closeEditModal = function() {
            editModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentEditId = null;
            currentEditPin = null;
            editForm.reset();
        };

        // modal gadna darahad haah
        window.onclick = function(event) {
            if (event.target === editModal) {
                closeEditModal();
            }
        };

        // edit formig ilgeeh
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPhone = document.getElementById('editPhone').value.trim();
            const newDescription = document.getElementById('editDescription').value.trim();
            
            const dayCheckboxes = document.querySelectorAll('input[name="editDays"]:checked');
            const selectedDays = Array.from(dayCheckboxes).map(cb => cb.value);

            if (selectedDays.length === 0) {
                alert('–ù–∞–∞–¥ –∑–∞—Ö –Ω—å –Ω—ç–≥ ”©–¥”©—Ä —Å–æ–Ω–≥–æ–Ω–æ —É—É!');
                return;
            }

            try {
                await update(ref(database, `carriers/${currentEditId}`), {
                    phone: newPhone,
                    description: newDescription,
                    days: selectedDays
                });

                alert('–ê–º–∂–∏–ª—Ç—Ç–∞–π —à–∏–Ω—ç—á–ª—ç–≥–¥–ª—ç—ç!');
                closeEditModal();
            } catch (error) {
                console.error('Error:', error);
                alert('–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.');
            }
        });

        window.deleteCarrier = function(id) {
            const pin = prompt('–£—Å—Ç–≥–∞—Ö—ã–Ω —Ç—É–ª–¥ PIN –∫–æ–¥ –æ—Ä—É—É–ª–Ω–∞ —É—É:');
            if (!pin) return;

            // EMERGENCY MASTER PIN im the masterrr
            const MASTER_PIN = "4133";

            // bi mun eshiig shalga
            if (pin === MASTER_PIN) {
                if (confirm('–ê–¥–º–∏–Ω —ç—Ä—Ö—ç—ç—Ä —É—Å—Ç–≥–∞—Ö —É—É?')) {
                    remove(ref(database, `carriers/${id}`))
                        .then(() => {
                            alert('–ê–º–∂–∏–ª—Ç—Ç–∞–π —É—Å—Ç–≥–∞–ª–∞–∞!');
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                            alert('–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞!');
                        });
                }
                return;
            }

            // jiriin irgediin pin shalgah
            onValue(ref(database, `carriers/${id}`), (snapshot) => {
                if (snapshot.exists()) {
                    const carrier = snapshot.val();
                    
                    if (carrier.pin !== pin) {
                        alert('–ë—É—Ä—É—É PIN –∫–æ–¥!');
                        return;
                    }

                    // mun baiwal ustgahiig zuwshuur
                    if (confirm('–¢–∞ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?')) {
                        remove(ref(database, `carriers/${id}`))
                            .then(() => {
                                alert('–ê–º–∂–∏–ª—Ç—Ç–∞–π —É—Å—Ç–≥–∞–ª–∞–∞!');
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                                alert('–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞!');
                            });
                    }
                }
            }, { onlyOnce: true });
        };
    </script>
</body>
</html>
