<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Хүргэгчид - Хөвсгөл Хүргэлт</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="page-header">
            <a href="index.html" class="back-link">← Буцах</a>
            <h1>Бүртгэлтэй хүргэгчид</h1>
        </header>

        <main>
            <div id="carriersContainer" class="carriers-grid">
                <p class="loading">Уншиж байна...</p>
            </div>
        </main>

        <footer>
            <p>Сургуулийн төсөл • Prototype</p>
        </footer>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyArvfvF1FWfqNAJnzfNiyEq0Lm2qioPIas",
            authDomain: "huwsgul-hurgelt.firebaseapp.com",
            databaseURL: "https://huwsgul-hurgelt-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "huwsgul-hurgelt",
            storageBucket: "huwsgul-hurgelt.firebasestorage.app",
            messagingSenderId: "457877716370",
            appId: "1:457877716370:web:5bc6e08801e36010c3d54b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const carriersRef = ref(database, 'carriers');

        // Listen for realtime updates from Firebase
        onValue(carriersRef, (snapshot) => {
            const container = document.getElementById('carriersContainer');
            container.innerHTML = '';

            if (!snapshot.exists()) {
                container.innerHTML = '<p class="no-data">Одоогоор хүргэгч бүртгэгдээгүй байна.</p>';
                return;
            }

            const carriers = snapshot.val();
            Object.keys(carriers).forEach(key => {
                const carrier = carriers[key];
                const card = createCarrierCard(key, carrier);
                container.appendChild(card);
            });
        });

        function createCarrierCard(id, carrier) {
            const card = document.createElement('div');
            card.className = 'carrier-card';
            
            // Format days for display
            const daysDisplay = carrier.days && carrier.days.length > 0 
                ? carrier.days.join(', ') 
                : 'Бүх өдөр';
            
            card.innerHTML = `
                <div class="card-content">
                    <div class="carrier-phone"> ${carrier.phone}</div>
                    <div class="carrier-description">${carrier.description}</div>
                    <div class="carrier-days"> ${daysDisplay}</div>
                </div>
                <div class="card-actions">
                    <button class="btn-small btn-edit" onclick="editCarrier('${id}', '${carrier.pin}', '${carrier.phone}', '${carrier.description.replace(/'/g, "\\'")}', '${JSON.stringify(carrier.days || [])}')">Засах</button>
                    <button class="btn-small btn-delete" onclick="deleteCarrier('${id}', '${carrier.pin}')">Устгах</button>
                </div>
            `;
            return card;
        }

        // Make functions global for onclick
        window.editCarrier = async function(id, correctPin, currentPhone, currentDescription, currentDaysJson) {
            const enteredPin = prompt('PIN код оруулна уу:');
            if (!enteredPin) return;

            if (enteredPin !== correctPin) {
                alert('Буруу PIN код!');
                return;
            }

            const newPhone = prompt('Шинэ утасны дугаар:', currentPhone);
            if (!newPhone) return;

            const newDescription = prompt('Шинэ тайлбар:', currentDescription);
            if (!newDescription) return;

            // Parse current days
            let currentDays = [];
            try {
                currentDays = JSON.parse(currentDaysJson);
            } catch (e) {
                currentDays = [];
            }

            // Create a simple days selection dialog
            const allDays = ['Даваа', 'Мягмар', 'Лхагва', 'Пүрэв', 'Баасан', 'Бямба', 'Ням'];
            const daysMessage = `Боломжтой өдрүүдээ сонгоно уу (тусгаарлагчаар: таслал)\nЖишээ: Даваа, Мягмар, Баасан\n\nОдоогийн: ${currentDays.join(', ')}`;
            const newDaysInput = prompt(daysMessage, currentDays.join(', '));
            
            if (newDaysInput === null) return;
            
            const newDays = newDaysInput.split(',').map(d => d.trim()).filter(d => d.length > 0);
            
            if (newDays.length === 0) {
                alert('Наад зах нь нэг өдөр сонгоно уу!');
                return;
            }

            try {
                await update(ref(database, `carriers/${id}`), {
                    phone: newPhone,
                    description: newDescription,
                    days: newDays
                });
                alert('Амжилттай засагдлаа!');
            } catch (error) {
                console.error('Error:', error);
                alert('Алдаа гарлаа. Дахин оролдоно уу.');
            }
        };

        window.deleteCarrier = async function(id, correctPin) {
            const enteredPin = prompt('PIN код оруулна уу:');
            if (!enteredPin) return;

            if (enteredPin !== correctPin) {
                alert('Буруу PIN код!');
                return;
            }

            if (!confirm('Үнэхээр устгах уу?')) return;

            try {
                await remove(ref(database, `carriers/${id}`));
                alert('Амжилттай устгагдлаа!');
            } catch (error) {
                console.error('Error:', error);
                alert('Алдаа гарлаа. Дахин оролдоно уу.');
            }
        };
    </script>
</body>
</html>
